<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ•‹ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø±Ù… Ø§Ù„Ù…ÙƒÙŠ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --border: #334155;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --green: #4ade80;
      --red: #f87171;
      --yellow: #fbbf24;
      --r: 12px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      direction: rtl;
    }

    /* â”€â”€ HEADER â”€â”€ */
    header {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%);
      border-bottom: 1px solid var(--border);
      padding: 18px 32px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    header .icon { font-size: 36px; }
    header h1 { font-size: 22px; font-weight: 700; }
    header .sub { font-size: 13px; color: var(--muted); margin-top: 2px; }

    /* â”€â”€ LAYOUT â”€â”€ */
    .main { padding: 24px 32px; max-width: 1500px; margin: 0 auto; }

    /* â”€â”€ UPLOAD â”€â”€ */
    .upload-zone {
      background: var(--card);
      border: 2px dashed var(--border);
      border-radius: var(--r);
      padding: 56px;
      text-align: center;
      cursor: pointer;
      transition: border-color .25s, background .25s;
      margin-bottom: 24px;
    }
    .upload-zone:hover, .upload-zone.over { border-color: var(--accent); background: #1a2f4a; }
    .upload-zone .ico { font-size: 52px; margin-bottom: 12px; }
    .upload-zone h3 { font-size: 18px; margin-bottom: 6px; }
    .upload-zone p { color: var(--muted); font-size: 13px; }
    #fileInput { display: none; }
    .btn {
      display: inline-block;
      background: var(--accent);
      color: #0f172a;
      border: none;
      padding: 10px 28px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      font-size: 14px;
      margin-top: 18px;
      transition: opacity .2s;
    }
    .btn:hover { opacity: .85; }
    .btn.secondary { background: #475569; color: var(--text); }

    /* â”€â”€ STATS CARDS â”€â”€ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 20px;
      position: relative;
      overflow: hidden;
    }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; right: 0;
      width: 4px; height: 100%;
      background: var(--accent-bar, var(--accent));
      border-radius: 0 var(--r) var(--r) 0;
    }
    .stat-card .lbl { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    .stat-card .val { font-size: 30px; font-weight: 700; }
    .stat-card .hint { font-size: 12px; color: var(--muted); margin-top: 4px; }

    /* â”€â”€ CHARTS GRID â”€â”€ */
    .g2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .g2.full { grid-template-columns: 1fr; }
    @media (max-width: 900px) { .g2 { grid-template-columns: 1fr; } .main { padding: 16px; } }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 20px;
    }
    .card h3 { font-size: 15px; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
    .chart-wrap { position: relative; height: 280px; }
    .chart-wrap.tall { height: 360px; }

    /* â”€â”€ TOGGLES â”€â”€ */
    .toggles { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .toggle-btn {
      padding: 4px 14px;
      border-radius: 20px;
      border: 1.5px solid currentColor;
      background: transparent;
      cursor: pointer;
      font-size: 12px;
      transition: all .2s;
    }
    .toggle-btn.active { color: #0f172a !important; }

    /* â”€â”€ HEATMAP â”€â”€ */
    .heatmap-scroll { overflow-x: auto; }
    .hm-table { border-collapse: collapse; direction: ltr; font-size: 11px; }
    .hm-table th {
      padding: 5px 3px;
      color: var(--muted);
      text-align: center;
      font-weight: 500;
      white-space: nowrap;
    }
    .hm-area { padding: 4px 10px; text-align: right !important; direction: rtl; color: var(--muted); white-space: nowrap; font-size: 11px; }
    .hm-cell {
      padding: 2px;
    }
    .hm-box {
      width: 44px; height: 34px;
      border-radius: 5px;
      display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 600; color: rgba(255,255,255,.9);
    }
    .legend-bar {
      margin-top: 12px;
      display: flex; align-items: center; gap: 14px;
      font-size: 12px; color: var(--muted);
    }
    .legend-grad {
      background: linear-gradient(90deg, #1d4ed8, #4ade80, #fbbf24, #f87171, #dc2626);
      width: 180px; height: 14px; border-radius: 4px;
    }

    /* â”€â”€ DATA TABLE â”€â”€ */
    .filter-bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 14px; }
    .filter-bar label { font-size: 13px; color: var(--muted); }
    .filter-bar input, .filter-bar select {
      background: #334155; border: 1px solid var(--border);
      color: var(--text); padding: 6px 12px; border-radius: 6px; font-size: 13px;
    }
    .tbl-scroll { overflow-x: auto; max-height: 420px; overflow-y: auto; }
    .data-tbl { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
    .data-tbl th {
      background: #1a2f4a; padding: 10px 14px; text-align: center;
      position: sticky; top: 0; font-weight: 600; border-bottom: 1px solid var(--border);
    }
    .data-tbl td { padding: 8px 14px; border-bottom: 1px solid #162032; text-align: center; }
    .data-tbl tr:hover { background: #1a2f4a; }
    .badge {
      padding: 3px 10px; border-radius: 20px;
      font-size: 11px; font-weight: 600; display: inline-block;
    }
    .b-red { background: rgba(248,113,113,.15); color: #f87171; border: 1px solid #f8717155; }
    .b-grn { background: rgba(74,222,128,.15); color: #4ade80; border: 1px solid #4ade8055; }
    .b-gray { background: rgba(100,116,139,.15); color: #94a3b8; border: 1px solid #94a3b855; }

    .hidden { display: none; }

    /* â”€â”€ BEST TIMES â”€â”€ */
    .best-times-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-bottom: 14px;
    }
    .bt-area-card {
      background: #162032;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .bt-area-card .area-name {
      font-size: 13px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .bt-area-card .best-window {
      font-size: 18px;
      font-weight: 700;
      color: #4ade80;
      font-family: monospace;
    }
    .bt-area-card .best-val {
      font-size: 12px;
      color: var(--muted);
    }
    .bt-area-card .worst-window {
      font-size: 12px;
      color: #f87171;
    }

    .hour-ranking {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      padding-bottom: 8px;
    }
    .hour-pill {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      min-width: 52px;
      padding: 10px 6px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 11px;
      background: #162032;
      flex-shrink: 0;
    }
    .hour-pill .hr-label { font-weight: 700; font-family: monospace; font-size: 13px; }
    .hour-pill .hr-val   { color: var(--muted); }
    .hour-pill .hr-rank  { font-size: 10px; font-weight: 700; }

    .rec-banner {
      background: linear-gradient(135deg, #14532d55, #052e1655);
      border: 1px solid #4ade8033;
      border-radius: var(--r);
      padding: 18px 22px;
      display: flex;
      align-items: flex-start;
      gap: 14px;
      margin-bottom: 14px;
    }
    .rec-banner .rec-icon { font-size: 30px; flex-shrink: 0; }
    .rec-banner h4 { font-size: 15px; color: #4ade80; margin-bottom: 6px; }
    .rec-banner ul { list-style: none; display: flex; flex-direction: column; gap: 5px; }
    .rec-banner ul li { font-size: 13px; color: var(--muted); display: flex; align-items: center; gap: 8px; }
    .rec-banner ul li::before { content: 'â€¢'; color: #4ade80; }

    .warn-banner {
      background: linear-gradient(135deg, #7f1d1d55, #450a0a55);
      border: 1px solid #f8717133;
      border-radius: var(--r);
      padding: 14px 22px;
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 14px;
      font-size: 13px;
    }
    .warn-banner .warn-icon { font-size: 24px; flex-shrink: 0; }
    .warn-banner strong { color: #f87171; }

    /* â”€â”€ UMRAH PLANNER â”€â”€ */
    .umrah-flow {
      display: flex;
      align-items: stretch;
      gap: 0;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .umrah-step {
      flex: 1;
      min-width: 160px;
      background: #162032;
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 18px;
      position: relative;
    }
    .umrah-step + .umrah-step { border-right: none; border-radius: 0 var(--r) var(--r) 0; }
    .umrah-step:first-child { border-radius: var(--r) 0 0 var(--r); }
    .umrah-arrow {
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; color: var(--muted); flex-shrink: 0;
      padding: 0 4px;
    }
    .umrah-step .step-num {
      font-size: 11px; font-weight: 700; color: var(--muted);
      text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;
    }
    .umrah-step .step-title {
      font-size: 15px; font-weight: 700; margin-bottom: 10px;
    }
    .umrah-step .step-best {
      font-size: 13px; color: #4ade80; font-weight: 600; margin-bottom: 4px;
    }
    .umrah-step .step-time {
      font-size: 22px; font-weight: 800; font-family: monospace;
    }
    .umrah-step .step-hint { font-size: 11px; color: var(--muted); margin-top: 4px; }

    .umrah-total {
      flex-shrink: 0;
      background: linear-gradient(135deg, #1e3a5f, #162032);
      border: 2px solid var(--accent);
      border-radius: var(--r);
      padding: 18px 24px;
      text-align: center;
      min-width: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 6px;
    }
    .umrah-total .tot-lbl { font-size: 12px; color: var(--muted); }
    .umrah-total .tot-val { font-size: 36px; font-weight: 800; color: var(--accent); font-family: monospace; }
    .umrah-total .tot-unit { font-size: 13px; color: var(--muted); }

    .umrah-hour-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 10px;
      margin-top: 16px;
    }
    .umrah-hour-card {
      background: #162032;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 10px;
      text-align: center;
    }
    .umrah-hour-card.best-hour {
      border-color: #4ade80;
      background: #0d2318;
    }
    .umrah-hour-card.worst-hour {
      border-color: #f87171;
      background: #2d0d0d;
    }
    .uhc-time { font-size: 14px; font-weight: 700; font-family: monospace; }
    .uhc-total { font-size: 20px; font-weight: 800; font-family: monospace; margin: 4px 0; }
    .uhc-detail { font-size: 10px; color: var(--muted); line-height: 1.5; }

    /* â”€â”€ SCENARIO TABS â”€â”€ */
    .scenario-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 18px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 14px;
    }
    .sc-tab {
      padding: 8px 18px;
      border-radius: 8px;
      border: 1.5px solid var(--border);
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all .2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .sc-tab:hover { border-color: var(--accent); color: var(--accent); }
    .sc-tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #0f172a;
    }

    /* comparison table */
    .sc-compare {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap: 10px;
      margin-top: 14px;
    }
    .sc-compare-card {
      background: #162032;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      text-align: center;
    }
    .sc-compare-card.active-sc { border-color: var(--accent); background: #1a2f4a; }
    .sc-compare-card .sc-name  { font-size: 11px; color: var(--muted); margin-bottom: 6px; }
    .sc-compare-card .sc-total { font-size: 26px; font-weight: 800; font-family: monospace; }
    .sc-compare-card .sc-sub   { font-size: 11px; color: var(--muted); margin-top: 4px; }
  </style>
</head>
<body>

<header>
  <div class="icon">ğŸ•‹</div>
  <div>
    <h1>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø±Ù… Ø§Ù„Ù…ÙƒÙŠ</h1>
    <div class="sub" id="hdrSub">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦</div>
  </div>
</header>

<div class="main">

  <!-- LOADING -->
  <div id="dropZone" style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:40px;text-align:center;margin-bottom:24px;">
    <div style="font-size:40px;margin-bottom:12px;">â³</div>
    <h3 id="loadMsg" style="font-size:16px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ haram_data_2026-02-26.csv â€¦</h3>
    <p id="loadErr" style="color:var(--red);margin-top:8px;display:none;"></p>
  </div>

  <!-- DASHBOARD -->
  <div id="dash" class="hidden">

    <!-- STAT CARDS -->
    <div class="stats-grid" id="statsGrid"></div>

    <!-- LINE CHART (full width) -->
    <div class="card" style="margin-bottom:16px;">
      <h3>ğŸ“ˆ ÙˆÙ‚Øª Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø¹ÙŠØ±Ø© Ø¹Ø¨Ø± Ø§Ù„ÙŠÙˆÙ… (Ø¯Ù‚ÙŠÙ‚Ø©) â€” Ø£Ù‚Ù„ = Ø£Ø³Ø±Ø¹ = Ø£Ù‚Ù„ Ø§Ø²Ø¯Ø­Ø§Ù…Ø§Ù‹</h3>
      <div class="toggles" id="areaToggles"></div>
      <div class="chart-wrap tall"><canvas id="lineChart"></canvas></div>
    </div>

    <!-- BAR + PIE -->
    <div class="g2" style="margin-bottom:16px;">
      <div class="card">
        <h3>ğŸ“Š Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥ØªÙ…Ø§Ù… Ù„ÙƒÙ„ Ù…Ù†Ø·Ù‚Ø© (Ø¯Ù‚ÙŠÙ‚Ø©)</h3>
        <div class="chart-wrap"><canvas id="barChart"></canvas></div>
      </div>
      <div class="card">
        <h3>ğŸ¥§ ØªÙˆØ²ÙŠØ¹ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¥Ø´Ø§Ø±Ø© â€” Ø£Ø®Ø¶Ø± / Ø£Ø­Ù…Ø± / ØºÙŠØ± Ù…ØªØ§Ø­</h3>
        <div class="chart-wrap"><canvas id="pieChart"></canvas></div>
      </div>
    </div>

    <!-- HEATMAP (full width) -->
    <div class="card" style="margin-bottom:16px;">
      <h3>ğŸŒ¡ï¸ Ø®Ø±ÙŠØ·Ø© Ø­Ø±Ø§Ø±ÙŠØ© â€” ÙˆÙ‚Øª Ø§Ù„Ø¥ØªÙ…Ø§Ù… (Ø¯Ù‚) Ø­Ø³Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø© ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø© â€” Ø£Ø²Ø±Ù‚/Ø£Ø®Ø¶Ø± = Ø³Ø±ÙŠØ¹ØŒ Ø£Ø­Ù…Ø± = Ø¨Ø·ÙŠØ¡</h3>
      <div class="heatmap-scroll" id="heatmapWrap"></div>
      <div class="legend-bar">
        <span>Ø£Ø³Ø±Ø¹ (Ø£Ù‚Ù„ Ø§Ø²Ø¯Ø­Ø§Ù…Ø§Ù‹)</span>
        <div class="legend-grad"></div>
        <span>Ø£Ø¨Ø·Ø£ (Ø£ÙƒØ«Ø± Ø§Ø²Ø¯Ø­Ø§Ù…Ø§Ù‹)</span>
        <span style="margin-right:auto;color:var(--muted);font-size:11px;">Ø§Ù„Ø£Ø±Ù‚Ø§Ù… = Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥ØªÙ…Ø§Ù… Ø¨Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©</span>
      </div>
    </div>

    <!-- UMRAH PLANNER -->
    <div class="card" style="margin-bottom:16px;" id="umrahPlannerCard">
      <h3>ğŸ•‹ Ù…Ø®Ø·Ø· Ø§Ù„Ø¹Ù…Ø±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© â€” Ø·ÙˆØ§Ù Ø«Ù… Ø³Ø¹ÙŠ</h3>

      <!-- scenario selector -->
      <div style="font-size:12px;color:var(--muted);margin-bottom:10px;">Ø§Ø®ØªØ± Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„Ø·ÙˆØ§Ù:</div>
      <div class="scenario-tabs" id="scenarioTabs"></div>

      <!-- best combo flow -->
      <div style="font-size:13px;color:var(--muted);margin-bottom:12px;" id="flowDesc"></div>
      <div class="umrah-flow" id="umrahFlow"></div>

      <!-- scenario comparison -->
      <div style="font-size:13px;color:var(--muted);margin:18px 0 10px;">Ù…Ù‚Ø§Ø±Ù†Ø© ÙƒÙ„ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª â€” Ø£ÙØ¶Ù„ Ø³Ø§Ø¹Ø© ÙÙŠ Ø§Ù„ÙŠÙˆÙ…:</div>
      <div class="sc-compare" id="scCompare"></div>

      <!-- per-hour breakdown -->
      <div style="font-size:13px;color:var(--muted);margin:18px 0 10px;" id="hourGridLabel">
        ÙˆÙ‚Øª Ø§Ù„Ø¹Ù…Ø±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„ÙƒÙ„ Ø³Ø§Ø¹Ø©:
      </div>
      <div class="umrah-hour-grid" id="umrahHourGrid"></div>
    </div>

    <!-- BEST TIMES -->
    <div class="card" style="margin-bottom:16px;" id="bestTimesCard">
      <h3>â° Ø£ÙØ¶Ù„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª â€” Ø§Ù„Ø£Ø³Ø±Ø¹ Ø¥ØªÙ…Ø§Ù…Ø§Ù‹ = Ø§Ù„Ø£Ù‚Ù„ Ø§Ø²Ø¯Ø­Ø§Ù…Ø§Ù‹</h3>

      <!-- recommendation banner -->
      <div class="rec-banner" id="recBanner"></div>

      <!-- warning banner -->
      <div class="warn-banner" id="warnBanner"></div>

      <!-- hour ranking strip -->
      <div style="margin-bottom:12px;">
        <div style="font-size:13px;color:var(--muted);margin-bottom:10px;">ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ù…Ù† Ø§Ù„Ø£Ø³Ø±Ø¹ Ù„Ù„Ø£Ø¨Ø·Ø£ Ø¥ØªÙ…Ø§Ù…Ø§Ù‹ â€” Ù…ØªÙˆØ³Ø· ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ (Ø¯Ù‚ÙŠÙ‚Ø©):</div>
        <div class="hour-ranking" id="hourRanking"></div>
      </div>

      <!-- per-area cards -->
      <div style="font-size:13px;color:var(--muted);margin-bottom:10px;">Ø£Ø³Ø±Ø¹ ÙˆØ£Ø¨Ø·Ø£ ÙˆÙ‚Øª Ø¥ØªÙ…Ø§Ù… Ù„ÙƒÙ„ Ù…Ù†Ø·Ù‚Ø©:</div>
      <div class="best-times-grid" id="bestTimesGrid"></div>
    </div>

    <!-- DATA TABLE -->
    <div class="card">
      <h3>ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
      <div class="filter-bar">
        <label>Ù…Ù†:</label>
        <input type="time" id="tStart" value="00:00">
        <label>Ø¥Ù„Ù‰:</label>
        <input type="time" id="tEnd" value="23:59">
        <button class="btn" style="padding:7px 18px;margin-top:0;" onclick="applyFilter()">ØªØµÙÙŠØ©</button>
        <button class="btn secondary" style="padding:7px 18px;margin-top:0;" onclick="resetFilter()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        <span id="rowCount" style="color:var(--muted);font-size:13px;margin-right:auto;"></span>
      </div>
      <div class="tbl-scroll">
        <table class="data-tbl">
          <thead>
            <tr>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
              <th>Ù…Ø³Ø¹Ù‰ Ø£Ø±Ø¶ÙŠ</th>
              <th>Ù…Ø³Ø¹Ù‰ Ø£ÙˆÙ„</th>
              <th>Ù…Ø³Ø¹Ù‰ Ø«Ø§Ù†ÙŠ</th>
              <th>Ø³Ø·Ø­ Ø§Ù„Ù…Ø·Ø§Ù</th>
              <th>ØµØ­Ù† Ø§Ù„Ù…Ø·Ø§Ù</th>
              <th>Ù…Ø·Ø§Ù Ø£Ø±Ø¶ÙŠ</th>
              <th>Ù…Ø·Ø§Ù Ø£ÙˆÙ„</th>
            </tr>
          </thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
    </div>

  </div><!-- /dash -->
</div><!-- /main -->

<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AREAS = [
  { key: 'masa_gnd',   label: 'Ù…Ø³Ø¹Ù‰ Ø£Ø±Ø¶ÙŠ',  color: '#38bdf8' },
  { key: 'masa_1st',   label: 'Ù…Ø³Ø¹Ù‰ Ø£ÙˆÙ„',   color: '#818cf8' },
  { key: 'masa_2nd',   label: 'Ù…Ø³Ø¹Ù‰ Ø«Ø§Ù†ÙŠ',  color: '#34d399' },
  { key: 'tawaf_roof', label: 'Ø³Ø·Ø­ Ø§Ù„Ù…Ø·Ø§Ù', color: '#fb923c' },
  { key: 'tawaf_crt',  label: 'ØµØ­Ù† Ø§Ù„Ù…Ø·Ø§Ù', color: '#f472b6' },
  { key: 'tawaf_gnd',  label: 'Ù…Ø·Ø§Ù Ø£Ø±Ø¶ÙŠ',  color: '#a78bfa' },
  { key: 'tawaf_1st',  label: 'Ù…Ø·Ø§Ù Ø£ÙˆÙ„',   color: '#fbbf24' },
];

let allData = [];
let charts = {};
let visibleAreas = new Set(AREAS.map(a => a.key));

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseRange(v) {
  if (!v) return null;
  v = v.replace(/"/g, '').trim();
  if (v === '' || v.includes('ØºÙŠØ± Ù…ØªØ§Ø­') || v.startsWith('rgba') || v.startsWith('rgb')) return null;
  const m = v.match(/(\d+)\s*[-â€“]\s*(\d+)/);
  return m ? (parseInt(m[1]) + parseInt(m[2])) / 2 : null;
}

function parseStatus(v) {
  if (!v) return 'gray';
  v = v.replace(/"/g, '');
  if (v.includes('Ø£Ø®Ø¶Ø±')) return 'green';
  if (v.includes('Ø£Ø­Ù…Ø±')) return 'red';
  return 'gray';
}

// minutes thresholds: lower = faster = less crowded
function heatColor(val) {
  if (val === null) return 'rgba(30,41,59,0.6)';
  if (val <= 32)  return 'rgba(29,78,216,0.85)';   // ~30 Ø¯Ù‚ â€” Ù…Ù…ØªØ§Ø²
  if (val <= 42)  return 'rgba(74,222,128,0.85)';   // ~40 Ø¯Ù‚ â€” Ø¬ÙŠØ¯
  if (val <= 55)  return 'rgba(251,191,36,0.85)';   // ~50 Ø¯Ù‚ â€” Ù…ØªÙˆØ³Ø·
  if (val <= 72)  return 'rgba(248,113,113,0.85)';  // ~70 Ø¯Ù‚ â€” Ù…Ø²Ø¯Ø­Ù…
  return 'rgba(220,38,38,0.95)';                    // 80+ Ø¯Ù‚ â€” Ø´Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø²Ø¯Ø­Ø§Ù…
}

// â”€â”€â”€ CSV PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseCSV(text) {
  // strip BOM
  text = text.replace(/^\uFEFF/, '');
  const lines = text.trim().split(/\r?\n/);
  const rows = [];

  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;

    // split respecting quoted fields
    const cols = [];
    let cur = '', inQ = false;
    for (const ch of line) {
      if (ch === '"') { inQ = !inQ; }
      else if (ch === ',' && !inQ) { cols.push(cur); cur = ''; }
      else cur += ch;
    }
    cols.push(cur);
    if (cols.length < 15) continue;

    const timeStr = cols[3].replace(/"/g, '').trim();
    const date = new Date(timeStr);
    if (isNaN(date)) continue;

    rows.push({
      time:      date,
      timeStr:   date.toTimeString().slice(0, 5),
      hour:      date.getHours(),
      // numeric crowd
      masa_gnd:   parseRange(cols[0]),
      masa_1st:   parseRange(cols[1]),
      masa_2nd:   parseRange(cols[2]),
      tawaf_roof: parseRange(cols[11]),
      tawaf_crt:  parseRange(cols[12]),
      tawaf_gnd:  parseRange(cols[13]),
      tawaf_1st:  parseRange(cols[14]),
      // status colors
      s_masa_gnd:   parseStatus(cols[4]),
      s_masa_1st:   parseStatus(cols[5]),
      s_masa_2nd:   parseStatus(cols[6]),
      s_tawaf_roof: parseStatus(cols[7]),
      s_tawaf_crt:  parseStatus(cols[8]),
      s_tawaf_gnd:  parseStatus(cols[9]),
      s_tawaf_1st:  parseStatus(cols[10]),
    });
  }
  return rows.sort((a, b) => a.time - b.time);
}

// â”€â”€â”€ RENDER ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll(data) {
  allData = data;
  document.getElementById('dash').classList.remove('hidden');
  document.getElementById('dropZone').classList.add('hidden');

  if (data.length) {
    const d = data[0].time;
    const fmt = d.toLocaleDateString('ar-SA', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    document.getElementById('hdrSub').textContent = `${fmt} â€” ${data.length} Ù‚Ø±Ø§Ø¡Ø©`;
  }

  renderStats(data);
  buildToggles(data);
  renderLine(data);
  renderBar(data);
  renderPie(data);
  renderHeatmap(data);
  renderUmrahPlanner(data);
  renderBestTimes(data);
  renderTable(data);
}

// â”€â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function avg(data, key) {
  const v = data.map(r => r[key]).filter(v => v !== null);
  return v.length ? v.reduce((a, b) => a + b, 0) / v.length : 0;
}

function renderStats(data) {
  const avgs = AREAS.map(a => avg(data, a.key));
  const maxIdx = avgs.indexOf(Math.max(...avgs));
  const minIdx = avgs.indexOf(Math.min(...avgs.filter(v => v > 0)));

  let peakVal = 0, peakLabel = '', peakTime = '';
  AREAS.forEach(a => {
    data.forEach(r => {
      if (r[a.key] !== null && r[a.key] > peakVal) {
        peakVal = r[a.key]; peakLabel = a.label; peakTime = r.timeStr;
      }
    });
  });

  // % of time masa_2nd is green
  const grn2 = data.filter(r => r.s_masa_2nd === 'green').length;
  const grn2pct = Math.round(grn2 / data.length * 100);

  // Ø£Ù‚Ù„ ÙˆÙ‚Øª Ø¹Ù…Ø±Ø© ÙƒØ§Ù…Ù„Ø©
  let minUmrah = Infinity, minUmrahTime = '';
  data.forEach(r => {
    const t = [r.tawaf_roof, r.tawaf_crt, r.tawaf_gnd, r.tawaf_1st].filter(v => v !== null);
    const s = [r.masa_gnd, r.masa_1st, r.masa_2nd].filter(v => v !== null);
    if (t.length && s.length) {
      const total = Math.min(...t) + Math.min(...s);
      if (total < minUmrah) { minUmrah = total; minUmrahTime = r.timeStr; }
    }
  });

  const CARDS = [
    { lbl: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª',              val: data.length,                   hint: 'ÙƒÙ„ ~5 Ø¯Ù‚Ø§Ø¦Ù‚', color: '#38bdf8' },
    { lbl: 'ğŸ•‹ Ø£Ù‚Ù„ ÙˆÙ‚Øª Ø¹Ù…Ø±Ø© ÙƒØ§Ù…Ù„Ø©',       val: minUmrah + ' Ø¯Ù‚',              hint: `Ø·ÙˆØ§Ù + Ø³Ø¹ÙŠ â€” Ø¹Ù†Ø¯ ${minUmrahTime}`, color: '#4ade80' },
    { lbl: 'Ø£Ø·ÙˆÙ„ ÙˆÙ‚Øª Ø¥ØªÙ…Ø§Ù… Ù…Ø³Ø¬Ù‘Ù„',         val: peakVal + ' Ø¯Ù‚',               hint: `${peakLabel} â€” ${peakTime}`, color: '#f87171' },
    { lbl: 'Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø²Ø¯Ø­Ø§Ù…Ø§Ù‹ (Ø£Ø¨Ø·Ø£)',       val: AREAS[maxIdx].label,           hint: `Ù…ØªÙˆØ³Ø· ${Math.round(avgs[maxIdx])} Ø¯Ù‚ÙŠÙ‚Ø©`, color: '#fb923c' },
    { lbl: 'Ø§Ù„Ø£Ù‚Ù„ Ø§Ø²Ø¯Ø­Ø§Ù…Ø§Ù‹ (Ø£Ø³Ø±Ø¹)',        val: AREAS[minIdx].label,           hint: `Ù…ØªÙˆØ³Ø· ${Math.round(avgs[minIdx])} Ø¯Ù‚ÙŠÙ‚Ø©`, color: '#34d399' },
    { lbl: 'Ø³Ø·Ø­ Ø§Ù„Ù…Ø·Ø§Ù (ØºÙŠØ± Ù…ØªØ§Ø­)',        val: data.filter(r => r.tawaf_roof === null).length, hint: 'Ù‚Ø±Ø§Ø¡Ø© Ù…Ø­Ø¬ÙˆØ¨', color: '#94a3b8' },
  ];

  document.getElementById('statsGrid').innerHTML = CARDS.map(c => `
    <div class="stat-card" style="--accent-bar:${c.color}">
      <div class="lbl">${c.lbl}</div>
      <div class="val" style="color:${c.color}">${c.val}</div>
      <div class="hint">${c.hint}</div>
    </div>`).join('');
}

// â”€â”€â”€ TOGGLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildToggles(data) {
  const wrap = document.getElementById('areaToggles');
  wrap.innerHTML = '';
  AREAS.forEach(a => {
    const btn = document.createElement('button');
    btn.className = 'toggle-btn' + (visibleAreas.has(a.key) ? ' active' : '');
    btn.textContent = a.label;
    btn.style.color = a.color;
    if (visibleAreas.has(a.key)) btn.style.background = a.color;
    btn.onclick = () => {
      visibleAreas.has(a.key) ? visibleAreas.delete(a.key) : visibleAreas.add(a.key);
      buildToggles(data);
      renderLine(data);
    };
    wrap.appendChild(btn);
  });
}

// â”€â”€â”€ LINE CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLine(data) {
  const labels = data.map(r => r.timeStr);
  const datasets = AREAS.filter(a => visibleAreas.has(a.key)).map(a => ({
    label: a.label,
    data: data.map(r => r[a.key]),
    borderColor: a.color,
    backgroundColor: a.color + '18',
    tension: 0.35,
    fill: false,
    spanGaps: true,
    pointRadius: 0,
    borderWidth: 2,
  }));

  const ctx = document.getElementById('lineChart');
  if (charts.line) charts.line.destroy();
  charts.line = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: '#94a3b8', font: { size: 11 } } },
        tooltip: {
          callbacks: {
            title: items => `Ø§Ù„ÙˆÙ‚Øª: ${items[0].label}`,
            label: c => `${c.dataset.label}: ${c.raw !== null ? c.raw + ' Ø¯Ù‚ÙŠÙ‚Ø©' : 'ØºÙŠØ± Ù…ØªØ§Ø­'}`
          }
        }
      },
      scales: {
        x: {
          ticks: { color: '#64748b', maxRotation: 45, maxTicksLimit: 24 },
          grid: { color: '#1e293b' }
        },
        y: {
          min: 0, max: 130,
          ticks: { color: '#64748b', callback: v => v + ' Ø¯Ù‚' },
          grid: { color: '#1e293b' },
          title: { display: true, text: 'ÙˆÙ‚Øª Ø§Ù„Ø¥ØªÙ…Ø§Ù… (Ø¯Ù‚ÙŠÙ‚Ø©)', color: '#64748b', font: { size: 11 } }
        }
      }
    }
  });
}

// â”€â”€â”€ BAR CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBar(data) {
  const avgs = AREAS.map(a => {
    const v = data.map(r => r[a.key]).filter(x => x !== null);
    return v.length ? Math.round(v.reduce((s, x) => s + x, 0) / v.length) : 0;
  });

  const ctx = document.getElementById('barChart');
  if (charts.bar) charts.bar.destroy();
  charts.bar = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: AREAS.map(a => a.label),
      datasets: [{
        label: 'Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥ØªÙ…Ø§Ù… (Ø¯Ù‚ÙŠÙ‚Ø©)',
        data: avgs,
        backgroundColor: AREAS.map(a => a.color + 'bb'),
        borderColor: AREAS.map(a => a.color),
        borderWidth: 1,
        borderRadius: 6,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: c => c.raw + ' Ø¯Ù‚ÙŠÙ‚Ø©' } }
      },
      scales: {
        x: { ticks: { color: '#64748b' }, grid: { display: false } },
        y: {
          min: 0, max: 130,
          ticks: { color: '#64748b', callback: v => v + ' Ø¯Ù‚' },
          grid: { color: '#1e293b' },
          title: { display: true, text: 'ÙˆÙ‚Øª Ø§Ù„Ø¥ØªÙ…Ø§Ù… (Ø¯Ù‚ÙŠÙ‚Ø©)', color: '#64748b', font: { size: 11 } }
        }
      }
    }
  });
}

// â”€â”€â”€ PIE CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPie(data) {
  const sKeys = ['s_masa_gnd','s_masa_1st','s_masa_2nd','s_tawaf_roof','s_tawaf_crt','s_tawaf_gnd','s_tawaf_1st'];
  let green = 0, red = 0, gray = 0;
  data.forEach(r => sKeys.forEach(k => {
    if (r[k] === 'green') green++;
    else if (r[k] === 'red') red++;
    else gray++;
  }));

  const ctx = document.getElementById('pieChart');
  if (charts.pie) charts.pie.destroy();
  charts.pie = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Ø£Ø®Ø¶Ø± â€” Ù‡Ø§Ø¯Ø¦', 'Ø£Ø­Ù…Ø± â€” Ù…Ø²Ø¯Ø­Ù…', 'Ø±Ù…Ø§Ø¯ÙŠ â€” ØºÙŠØ± Ù…ØªØ§Ø­'],
      datasets: [{
        data: [green, red, gray],
        backgroundColor: ['#4ade8055', '#f8717155', '#47556955'],
        borderColor: ['#4ade80', '#f87171', '#475569'],
        borderWidth: 2,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: '#94a3b8', font: { size: 12 } }, position: 'bottom' },
        tooltip: {
          callbacks: {
            label: c => {
              const tot = c.dataset.data.reduce((a, b) => a + b, 0);
              return `${c.label}: ${c.raw.toLocaleString()} (${Math.round(c.raw / tot * 100)}%)`;
            }
          }
        }
      }
    }
  });
}

// â”€â”€â”€ HEATMAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHeatmap(data) {
  const hours = [...new Set(data.map(r => r.hour))].sort((a, b) => a - b);
  const byHour = {};
  hours.forEach(h => byHour[h] = data.filter(r => r.hour === h));

  let html = '<table class="hm-table"><thead><tr><th style="text-align:right;direction:rtl;padding-left:10px;">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>';
  hours.forEach(h => html += `<th>${String(h).padStart(2,'0')}:00</th>`);
  html += '</tr></thead><tbody>';

  AREAS.forEach(area => {
    html += `<tr><td class="hm-area">${area.label}</td>`;
    hours.forEach(h => {
      const vals = byHour[h].map(r => r[area.key]).filter(v => v !== null);
      const avg = vals.length ? Math.round(vals.reduce((s, v) => s + v, 0) / vals.length) : null;
      const bg = heatColor(avg);
      html += `<td class="hm-cell"><div class="hm-box" style="background:${bg}" title="${area.label} â€” ${avg !== null ? avg + ' Ø¯Ù‚ÙŠÙ‚Ø©' : 'ØºÙŠØ± Ù…ØªØ§Ø­'}">${avg !== null ? avg + 'Ø¯' : 'â€”'}</div></td>`;
    });
    html += '</tr>';
  });

  html += '</tbody></table>';
  document.getElementById('heatmapWrap').innerHTML = html;
}

// â”€â”€â”€ UMRAH PLANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Ø§Ù„Ø³Ø¹ÙŠ: ÙƒÙ„ Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…Ø³Ø¹Ù‰
const SAI_KEYS = [
  { key: 'masa_gnd', label: 'Ù…Ø³Ø¹Ù‰ Ø§Ù„Ø£Ø±Ø¶ÙŠ' },
  { key: 'masa_1st', label: 'Ù…Ø³Ø¹Ù‰ Ø§Ù„Ø£ÙˆÙ„'  },
  { key: 'masa_2nd', label: 'Ù…Ø³Ø¹Ù‰ Ø§Ù„Ø«Ø§Ù†ÙŠ' },
];

// Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª: ÙƒÙ„ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ ÙŠØ­Ø¯Ø¯ Ø£ÙŠ Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø·ÙˆØ§Ù Ø§Ù„Ù…ØªØ§Ø­Ø©
const SCENARIOS = [
  {
    id: 'auto',
    label: 'ğŸ† Ø£ÙØ¶Ù„ Ø¯ÙˆØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹',
    desc: 'ÙŠØ®ØªØ§Ø± Ø£Ø³Ø±Ø¹ Ø¯ÙˆØ± Ù„Ù„Ù…Ø·Ø§Ù + Ø£Ø³Ø±Ø¹ Ø¯ÙˆØ± Ù„Ù„Ù…Ø³Ø¹Ù‰ ÙÙŠ ÙƒÙ„ ÙˆÙ‚Øª',
    tawafKeys: [
      { key: 'tawaf_roof', label: 'Ø³Ø·Ø­ Ø§Ù„Ù…Ø·Ø§Ù'  },
      { key: 'tawaf_crt',  label: 'ØµØ­Ù† Ø§Ù„Ù…Ø·Ø§Ù'  },
      { key: 'tawaf_gnd',  label: 'Ù…Ø·Ø§Ù Ø§Ù„Ø£Ø±Ø¶ÙŠ' },
      { key: 'tawaf_1st',  label: 'Ù…Ø·Ø§Ù Ø§Ù„Ø£ÙˆÙ„'  },
    ],
  },
  {
    id: 'sahn',
    label: 'ğŸ•Œ ØµØ­Ù† Ø§Ù„Ù…Ø·Ø§Ù Ø¯Ø§Ø¦Ù…Ø§Ù‹',
    desc: 'Ø§Ù„Ø·ÙˆØ§Ù ÙÙŠ Ø§Ù„ØµØ­Ù† (Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙƒØ¹Ø¨Ø©) â€” Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„Ø£Ø´ÙŠØ¹',
    tawafKeys: [{ key: 'tawaf_crt', label: 'ØµØ­Ù† Ø§Ù„Ù…Ø·Ø§Ù' }],
  },
  {
    id: 'roof',
    label: 'ğŸŒ™ Ø³Ø·Ø­ Ø§Ù„Ù…Ø·Ø§Ù Ø¯Ø§Ø¦Ù…Ø§Ù‹',
    desc: 'Ø§Ù„Ø·ÙˆØ§Ù ÙÙŠ Ø§Ù„Ø³Ø·Ø­ â€” Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ù…ØªØ§Ø­Ø§Ù‹',
    tawafKeys: [{ key: 'tawaf_roof', label: 'Ø³Ø·Ø­ Ø§Ù„Ù…Ø·Ø§Ù' }],
  },
  {
    id: 'gnd',
    label: 'ğŸ›ï¸ Ù…Ø·Ø§Ù Ø§Ù„Ø£Ø±Ø¶ÙŠ Ø¯Ø§Ø¦Ù…Ø§Ù‹',
    desc: 'Ø§Ù„Ø·ÙˆØ§Ù ÙÙŠ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø£Ø±Ø¶ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¨Ù†Ù‰',
    tawafKeys: [{ key: 'tawaf_gnd', label: 'Ù…Ø·Ø§Ù Ø§Ù„Ø£Ø±Ø¶ÙŠ' }],
  },
  {
    id: 'first',
    label: 'ğŸ“¶ Ù…Ø·Ø§Ù Ø§Ù„Ø£ÙˆÙ„ Ø¯Ø§Ø¦Ù…Ø§Ù‹',
    desc: 'Ø§Ù„Ø·ÙˆØ§Ù ÙÙŠ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø£ÙˆÙ„',
    tawafKeys: [{ key: 'tawaf_1st', label: 'Ù…Ø·Ø§Ù Ø§Ù„Ø£ÙˆÙ„' }],
  },
];

let activeScenario = 'sahn'; // default: ØµØ­Ù† Ø§Ù„Ù…Ø·Ø§Ù
let _plannerData   = null;

function bestOption(row, options) {
  let best = null, bestLabel = '';
  options.forEach(o => {
    if (row[o.key] !== null && (best === null || row[o.key] < best)) {
      best = row[o.key]; bestLabel = o.label;
    }
  });
  return { val: best, label: bestLabel };
}

function bestSai(row) {
  return bestOption(row, SAI_KEYS);
}

function calcHourlyForScenario(data, scenario) {
  const hours = [...new Set(data.map(r => r.hour))].sort((a, b) => a - b);
  return hours.map(h => {
    const rows = data.filter(r => r.hour === h);
    const totals = rows.map(r => {
      const t = bestOption(r, scenario.tawafKeys);
      const s = bestSai(r);
      if (t.val === null || s.val === null) return null;
      return { total: t.val + s.val, tawafVal: t.val, tawafLabel: t.label, saiVal: s.val, saiLabel: s.label };
    }).filter(x => x !== null);

    if (!totals.length) return null;
    const avgTotal = totals.reduce((a, b) => a + b.total, 0) / totals.length;
    const avgTawaf = totals.reduce((a, b) => a + b.tawafVal, 0) / totals.length;
    const avgSai   = totals.reduce((a, b) => a + b.saiVal,   0) / totals.length;

    // most frequent label
    const tFreq = {}, sFreq = {};
    totals.forEach(x => {
      tFreq[x.tawafLabel] = (tFreq[x.tawafLabel]||0)+1;
      sFreq[x.saiLabel]   = (sFreq[x.saiLabel]  ||0)+1;
    });
    const topTawaf = Object.entries(tFreq).sort((a,b)=>b[1]-a[1])[0][0];
    const topSai   = Object.entries(sFreq).sort((a,b)=>b[1]-a[1])[0][0];

    return { hour: h, total: avgTotal, tawaf: avgTawaf, sai: avgSai, tawafLabel: topTawaf, saiLabel: topSai };
  }).filter(x => x !== null);
}

function renderUmrahPlanner(data) {
  _plannerData = data;

  // â”€â”€ scenario tabs â”€â”€
  const tabsEl = document.getElementById('scenarioTabs');
  tabsEl.innerHTML = SCENARIOS.map(sc => `
    <button class="sc-tab ${sc.id === activeScenario ? 'active' : ''}"
            onclick="switchScenario('${sc.id}')">${sc.label}</button>
  `).join('');

  // â”€â”€ scenario comparison (best hour for each) â”€â”€
  const compareEl = document.getElementById('scCompare');
  compareEl.innerHTML = SCENARIOS.map(sc => {
    const hourly = calcHourlyForScenario(data, sc).sort((a,b) => a.total - b.total);
    if (!hourly.length) return `<div class="sc-compare-card"><div class="sc-name">${sc.label}</div><div class="sc-total" style="color:var(--muted)">â€”</div><div class="sc-sub">Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª</div></div>`;
    const best = hourly[0];
    const totalColor = best.total <= 90 ? '#4ade80' : best.total <= 115 ? '#fbbf24' : '#f87171';
    return `
      <div class="sc-compare-card ${sc.id === activeScenario ? 'active-sc' : ''}" onclick="switchScenario('${sc.id}')" style="cursor:pointer;">
        <div class="sc-name">${sc.label}</div>
        <div class="sc-total" style="color:${totalColor}">${Math.round(best.total)} Ø¯Ù‚</div>
        <div class="sc-sub">Ø£ÙØ¶Ù„: ${String(best.hour).padStart(2,'0')}:00</div>
        <div class="sc-sub">ğŸ•Œ${Math.round(best.tawaf)}Ø¯ + ğŸš¶${Math.round(best.sai)}Ø¯</div>
      </div>`;
  }).join('');

  drawScenario(data, activeScenario);
}

function switchScenario(id) {
  activeScenario = id;
  if (_plannerData) renderUmrahPlanner(_plannerData);
}

function drawScenario(data, scenarioId) {
  const sc = SCENARIOS.find(s => s.id === scenarioId);
  const hourly = calcHourlyForScenario(data, sc);
  if (!hourly.length) return;

  hourly.sort((a,b) => a.total - b.total);
  const best  = hourly[0];
  const worst = hourly[hourly.length - 1];
  hourly.sort((a,b) => a.hour - b.hour);

  document.getElementById('flowDesc').textContent = sc.desc;

  // â”€â”€ flow card â”€â”€
  const flowEl = document.getElementById('umrahFlow');
  flowEl.innerHTML = `
    <div class="umrah-step">
      <div class="step-num">Ø§Ù„Ø®Ø·ÙˆØ© 1</div>
      <div class="step-title">ğŸ•Œ Ø§Ù„Ø·ÙˆØ§Ù</div>
      <div class="step-best">${sc.tawafKeys.length > 1 ? 'Ø£ÙØ¶Ù„ Ø¯ÙˆØ±: ' : 'Ø§Ù„Ø¯ÙˆØ±: '}${best.tawafLabel}</div>
      <div class="step-time" style="color:#fb923c">${Math.round(best.tawaf)} Ø¯Ù‚</div>
      <div class="step-hint">Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø© ${String(best.hour).padStart(2,'0')}:00</div>
    </div>
    <div class="umrah-arrow">â†</div>
    <div class="umrah-step">
      <div class="step-num">Ø§Ù„Ø®Ø·ÙˆØ© 2</div>
      <div class="step-title">ğŸš¶ Ø§Ù„Ø³Ø¹ÙŠ</div>
      <div class="step-best">Ø£ÙØ¶Ù„ Ø¯ÙˆØ±: ${best.saiLabel}</div>
      <div class="step-time" style="color:#818cf8">${Math.round(best.sai)} Ø¯Ù‚</div>
      <div class="step-hint">Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø© ${String(best.hour).padStart(2,'0')}:00</div>
    </div>
    <div class="umrah-arrow">=</div>
    <div class="umrah-total">
      <div class="tot-lbl">Ø£Ù‚Ù„ ÙˆÙ‚Øª Ù„Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ø±Ø© ÙƒØ§Ù…Ù„Ø©</div>
      <div class="tot-val">${Math.round(best.total)}</div>
      <div class="tot-unit">Ø¯Ù‚ÙŠÙ‚Ø© ğŸ†</div>
      <div style="font-size:11px;color:#4ade80;margin-top:6px;">Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø© ${String(best.hour).padStart(2,'0')}:00</div>
      <div style="font-size:11px;color:#f87171;margin-top:2px;">Ø£Ø³ÙˆØ£: ${String(worst.hour).padStart(2,'0')}:00 â€” ${Math.round(worst.total)} Ø¯Ù‚</div>
    </div>`;

  // â”€â”€ per-hour grid â”€â”€
  document.getElementById('hourGridLabel').textContent =
    `ÙˆÙ‚Øª Ø§Ù„Ø¹Ù…Ø±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„ÙƒÙ„ Ø³Ø§Ø¹Ø© â€” ${sc.label}:`;

  const minTotal = Math.min(...hourly.map(h => h.total));
  const maxTotal = Math.max(...hourly.map(h => h.total));

  document.getElementById('umrahHourGrid').innerHTML = hourly.map(h => {
    const isBest  = Math.round(h.total) === Math.round(minTotal);
    const isWorst = Math.round(h.total) === Math.round(maxTotal);
    const cls = isBest ? 'umrah-hour-card best-hour' : isWorst ? 'umrah-hour-card worst-hour' : 'umrah-hour-card';
    const icon = isBest ? 'ğŸ¥‡' : isWorst ? 'ğŸ”´' : '';
    const totalColor = h.total <= 90 ? '#4ade80' : h.total <= 115 ? '#fbbf24' : '#f87171';
    return `
      <div class="${cls}">
        <div class="uhc-time">${icon} ${String(h.hour).padStart(2,'0')}:00</div>
        <div class="uhc-total" style="color:${totalColor}">${Math.round(h.total)} Ø¯Ù‚</div>
        <div class="uhc-detail">
          ğŸ•Œ ${h.tawafLabel}: ${Math.round(h.tawaf)} Ø¯<br>
          ğŸš¶ ${h.saiLabel}: ${Math.round(h.sai)} Ø¯
        </div>
      </div>`;
  }).join('');
}

// â”€â”€â”€ BEST TIMES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBestTimes(data) {
  const hours = [...new Set(data.map(r => r.hour))].sort((a, b) => a - b);

  // â”€â”€ combined avg per hour (all areas) â”€â”€
  const hourAvgs = hours.map(h => {
    const rows = data.filter(r => r.hour === h);
    let sum = 0, cnt = 0;
    AREAS.forEach(a => {
      rows.forEach(r => { if (r[a.key] !== null) { sum += r[a.key]; cnt++; } });
    });
    return { hour: h, avg: cnt ? sum / cnt : null };
  }).filter(h => h.avg !== null).sort((a, b) => a.avg - b.avg);

  // â”€â”€ hour ranking strip â”€â”€
  const rankWrap = document.getElementById('hourRanking');
  const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
  rankWrap.innerHTML = hourAvgs.map((h, i) => {
    const bg = i < 3  ? 'border-color:#4ade80;background:#0d2318;'
             : i >= hourAvgs.length - 3 ? 'border-color:#f87171;background:#2d0d0d;'
             : '';
    const rankLabel = i < 3 ? medals[i] : i >= hourAvgs.length - 3 ? 'ğŸ”´' : '';
    return `
      <div class="hour-pill" style="${bg}">
        <span class="hr-rank">${rankLabel || '#' + (i + 1)}</span>
        <span class="hr-label">${String(h.hour).padStart(2,'0')}:00</span>
        <span class="hr-val">${Math.round(h.avg)} Ø¯</span>
      </div>`;
  }).join('');

  // â”€â”€ per-area best/worst â”€â”€
  const areaIcons = { masa_gnd:'ğŸš¶', masa_1st:'ğŸš¶', masa_2nd:'ğŸš¶', tawaf_roof:'ğŸ•Œ', tawaf_crt:'ğŸ•Œ', tawaf_gnd:'ğŸ•Œ', tawaf_1st:'ğŸ•Œ' };
  const grid = document.getElementById('bestTimesGrid');
  grid.innerHTML = AREAS.map(a => {
    const hourData = hours.map(h => {
      const rows = data.filter(r => r.hour === h && r[a.key] !== null);
      const v = rows.map(r => r[a.key]);
      const avg = v.length ? v.reduce((s,x) => s+x,0)/v.length : null;
      return { hour: h, avg };
    }).filter(h => h.avg !== null).sort((a, b) => a.avg - b.avg);

    if (!hourData.length) return '';

    const best  = hourData[0];
    const worst = hourData[hourData.length - 1];

    // find contiguous best window (hours within 5% of best)
    const threshold = best.avg * 1.08;
    const goodHours = hourData.filter(h => h.avg <= threshold).map(h => h.hour).sort((a,b)=>a-b);
    const winStart = goodHours[0];
    const winEnd   = goodHours[goodHours.length - 1];

    return `
      <div class="bt-area-card" style="border-right: 3px solid ${a.color}30;">
        <div class="area-name" style="color:${a.color}">${areaIcons[a.key]} ${a.label}</div>
        <div class="best-window">${String(winStart).padStart(2,'0')}:00 â€“ ${String(winEnd).padStart(2,'0')}:59</div>
        <div class="best-val">Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª Ø¥ØªÙ…Ø§Ù…: <strong style="color:#4ade80">${Math.round(best.avg)} Ø¯Ù‚ÙŠÙ‚Ø©</strong> Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø© ${String(best.hour).padStart(2,'0')}:00</div>
        <div class="worst-window">âš ï¸ Ø£Ø¨Ø·Ø£ ÙˆÙ‚Øª: ${String(worst.hour).padStart(2,'0')}:00 â€” ${Math.round(worst.avg)} Ø¯Ù‚ÙŠÙ‚Ø©</div>
      </div>`;
  }).join('');

  // â”€â”€ recommendation banner â”€â”€
  const bestHour  = hourAvgs[0];
  const best3     = hourAvgs.slice(0, 3).map(h => String(h.hour).padStart(2,'0') + ':00').join('ØŒ ');
  const worstHour = hourAvgs[hourAvgs.length - 1];
  document.getElementById('recBanner').innerHTML = `
    <div class="rec-icon">âœ…</div>
    <div>
      <h4>Ø£ÙØ¶Ù„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ù„Ù„Ø²ÙŠØ§Ø±Ø©</h4>
      <ul>
        <li>Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª Ø¥ØªÙ…Ø§Ù… ÙÙŠ Ø§Ù„ÙŠÙˆÙ…: Ø³Ø§Ø¹Ø© <strong style="color:#4ade80">${String(bestHour.hour).padStart(2,'0')}:00</strong> â€” Ù…ØªÙˆØ³Ø· ${Math.round(bestHour.avg)} Ø¯Ù‚ÙŠÙ‚Ø© ÙÙ‚Ø· Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø¹ÙŠØ±Ø©</li>
        <li>Ø£ÙØ¶Ù„ 3 Ø³Ø§Ø¹Ø§Øª (Ø£Ù‚Ù„ Ø§Ø²Ø¯Ø­Ø§Ù…Ø§Ù‹): <strong style="color:#4ade80">${best3}</strong></li>
        <li>Ø§Ù„Ù…Ø³Ø¹Ù‰ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø§Ù„Ø£Ø³Ø±Ø¹ (25â€“35 Ø¯Ù‚) â€” ÙŠÙÙ†ØµØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø±Ø¶ÙŠ Ø£Ùˆ Ø§Ù„Ø£ÙˆÙ„</li>
        <li>Ø§Ù„Ù…Ø·Ø§Ù Ø§Ù„Ø£Ø±Ø¶ÙŠ ÙˆØ§Ù„Ø£ÙˆÙ„: Ø£Ø³Ø±Ø¹ Ù…Ø§ ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ ÙˆØ§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹ (50â€“60 Ø¯Ù‚ÙŠÙ‚Ø©)</li>
      </ul>
    </div>`;

  // â”€â”€ warning banner â”€â”€
  document.getElementById('warnBanner').innerHTML = `
    <div class="warn-icon">âš ï¸</div>
    <span>ØªØ¬Ù†Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø© <strong>${String(worstHour.hour).padStart(2,'0')}:00</strong> â€” Ø£Ø¹Ù„Ù‰ Ø§Ø²Ø¯Ø­Ø§Ù… ÙÙŠ Ø§Ù„ÙŠÙˆÙ…ØŒ Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥ØªÙ…Ø§Ù… ${Math.round(worstHour.avg)} Ø¯Ù‚ÙŠÙ‚Ø© Ø¹Ø¨Ø± ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</span>`;
}

// â”€â”€â”€ DATA TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function badge(val, status) {
  if (val === null) return '<span class="badge b-gray">Øº.Ù…</span>';
  const cls = status === 'green' ? 'b-grn' : status === 'red' ? 'b-red' : 'b-gray';
  return `<span class="badge ${cls}">${val} Ø¯Ù‚</span>`;
}

function renderTable(data, filtered = null) {
  const rows = filtered || data;
  document.getElementById('rowCount').textContent = `${rows.length} ØµÙ`;
  document.getElementById('tblBody').innerHTML = rows.map(r => `
    <tr>
      <td style="font-family:monospace;color:var(--muted)">${r.timeStr}</td>
      <td>${badge(r.masa_gnd,   r.s_masa_gnd)}</td>
      <td>${badge(r.masa_1st,   r.s_masa_1st)}</td>
      <td>${badge(r.masa_2nd,   r.s_masa_2nd)}</td>
      <td>${badge(r.tawaf_roof, r.s_tawaf_roof)}</td>
      <td>${badge(r.tawaf_crt,  r.s_tawaf_crt)}</td>
      <td>${badge(r.tawaf_gnd,  r.s_tawaf_gnd)}</td>
      <td>${badge(r.tawaf_1st,  r.s_tawaf_1st)}</td>
    </tr>`).join('');
}

function applyFilter() {
  const s = document.getElementById('tStart').value;
  const e = document.getElementById('tEnd').value;
  renderTable(allData, allData.filter(r => r.timeStr >= s && r.timeStr <= e));
}

function resetFilter() {
  document.getElementById('tStart').value = '00:00';
  document.getElementById('tEnd').value   = '23:59';
  renderTable(allData);
}

// â”€â”€â”€ AUTO LOAD CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CSV_FILE = 'haram_data_2026-02-26.csv';

fetch(CSV_FILE)
  .then(r => {
    if (!r.ok) throw new Error(`HTTP ${r.status} â€” ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ ${CSV_FILE}`);
    return r.text();
  })
  .then(text => {
    renderAll(parseCSV(text));
  })
  .catch(err => {
    document.getElementById('loadMsg').style.display = 'none';
    const el = document.getElementById('loadErr');
    el.style.display = 'block';
    el.textContent = 'Ø®Ø·Ø£: ' + err.message + ' â€” ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯';
    document.getElementById('hdrSub').textContent = 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
  });
</script>

</body>
</html>
