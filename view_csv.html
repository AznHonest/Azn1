<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CSV Browser</title>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

<style>
  body { font-family: Arial, sans-serif; margin: 14px; }
  h2 { margin: 0 0 10px 0; font-size: 18px; }

  .bar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
  select, input[type="text"], button { padding: 8px; font-size: 14px; }
  #status { color:#666; font-size:12px; }

  /* Desktop table tweaks */
  #csvTable thead th { text-align: center !important; vertical-align: middle; }
  #csvTable tbody td { text-align: center; vertical-align: middle; overflow: visible; }
  #csvTable td.col-title { text-align: left !important; }

  .img-wrap { display:inline-block; overflow:visible; }
  .img-wrap img {
    max-height: 40px; border-radius: 6px; background:#fff; cursor:pointer;
    transition: transform .2s ease, box-shadow .2s ease;
    transform-origin: left center;
  }
  @media (hover:hover) and (pointer:fine){
    .img-wrap:hover img {
      transform: scale(4);
      z-index: 9999;
      position: relative;
      box-shadow: 0 12px 35px rgba(0,0,0,0.35);
      border-radius: 12px;
    }
  }

  /* ====== Mobile Cards ====== */
  #cards { display:none; }
  .card {
    border: 1px solid #e6e6e6;
    border-radius: 14px;
    padding: 10px;
    margin: 10px 0;
    display:flex;
    gap:10px;
    align-items:flex-start;
    background:#fff;
  }
  .card-img img{
    width: 78px; height: 78px; object-fit: cover;
    border-radius: 12px; background:#fff;
    border: 1px solid #f0f0f0;
  }
  .card-main{ flex:1; min-width:0; }
  .card-title{
    font-size: 14px; line-height: 1.25;
    margin: 0 0 8px 0;
    word-break: break-word;
    font-weight: 600;
  }
  .meta{
    display:flex; flex-wrap:wrap; gap:7px;
    font-size: 12px; color:#222;
  }
  .pill{
    background:#f4f4f4; border-radius: 999px;
    padding: 4px 8px;
    border: 1px solid #eee;
    white-space: nowrap;
  }
  .card-actions{
    margin-top: 9px;
    display:flex; gap:8px; flex-wrap:wrap;
  }
  .btn{
    display:inline-block;
    padding: 8px 10px;
    border-radius: 12px;
    border: 1px solid #ddd;
    text-decoration:none;
    color:#111;
    font-size: 13px;
    background:#fff;
  }
  .btn.primary{
    border-color:#cfcfcf;
    font-weight:700;
  }

  @media (max-width: 820px){
    .bar{ flex-direction: column; align-items: stretch; gap:8px; }
    #csvSelect, #quickSearch, #reloadBtn { width: 100%; }
  }

  table.dataTable thead th {
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 2;
  }
</style>
</head>

<body>
<h2>CSV Browser</h2>

<div class="bar">
  <select id="csvSelect"></select>
  <input id="quickSearch" type="text" placeholder="Search title / keyword..." />
  <button id="reloadBtn">Reload</button>
  <span id="status"></span>
</div>

<!-- Desktop -->
<table id="csvTable" class="display compact stripe" style="width:100%"></table>

<!-- Mobile -->
<div id="cards"></div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* ============ CONFIG ============ */
const CSV_FILES = [
  "Best Sellers in Toys & Games_amazon_2026-02-01_100.csv",
  "Best Sellers in Beauty & Personal Care_amazon_2026-02-01_100.csv",
  "Best Sellers in Home Travel-Size Air Purifiers_amazon_2026-02-01_100.csv",
  "Best Sellers in Home Air Ionizers_amazon_2026-02-01_100.csv",
  "Best Sellers in Home Air Purifiers_amazon_2026-02-01_100.csv",
  "Best Sellers in Humidifiers_amazon_2026-02-01_100.csv",
  "Best_Sellers_in_Mattress_Pads_amazon_2026-02-01_100.csv",
  "Best_Sellers_in_Ironing_Products_amazon_2026-02-01_50.csv",
  "Best_Sellers_in_Choppers_&_Mincers_amazon_2026-02-01_100.csv",
  "Best_Sellers_in_Seasoning_&_Spice_Choppers_amazon_2026-02-01_100.csv",
  "Best_Sellers_in_Grocery_&_Gourmet_Food_amazon_2026-02-01_100.csv",
  "Best_Sellers_in_Matcha_Tea_amazon_2026-02-01_100.csv",
  "Best_Sellers_in_Kitchen_&_Dining_amazon_2026-02-01_100.csv",
  "Best_Sellers_in_Home_&_Kitchen_amazon_2026-02-01_100.csv",
  "Power_Strips_&_Surge_Protectors_7pages_outof400pages_amazon_2026-02-01_169.csv",
  "Search_Bath_Soaps_7outof_7pages_amazon_2026-02-01_325.csv",
  "Fire_Safety_best_8pages_outof_400pagesamazon_2026_01_28_183_products (2).csv",
  "Fire_Extinguishers_10pages_outof_67pages_amazon_2026_01_28_267_products.csv",
  "Fire_Safety_best_8pages_outof_400p_Testing - Copy.csv",
  "first_aid_Search_7pages_amazon_2026-01-28_320_products.csv",
  "Baby_Safety_Products_best_10pages_outof_400pages_amazon_2026_01.csv",
  "Baby_Safety_Products_best_10pages_outof_400pages_amazon_2026-01-28_263_products.csv",
  "collagen_best_7_pages_manual_amazon_2026-01-27_280_products.csv",
  "collagen_best_7_pages_manual_amazon_2026-01-27_280_products (2).csv",
  "Collagen_Supplements_166Pages_amazon_2026_01_27_4066_products_1.csv",
  "Collagen_Supplements_166Pages_amazon_2026_01_27_4066_products (1).csv",
  "Vitamin_C_Supplements_15pages_outof_117pages_amazon_2026_01_28_358.csv",
  "Vitamins,_Minerals_&_Supplements_10pages_outof_400_amazon_2026_01.csv",
  "Vitamins_15Pages_out_of_400page_amazon_2026_01_27_233_products.csv",
  "sleep_supplements_170pages_amazon_us.csv",
  "collagen_117pages.csv",
  "collagen_117pages_all_split_final.csv",
  "400pages_all_split_final.csv"
];

// Desktop columns (supports both naming styles)
const VISIBLE_COLS = [
  "image","title","price","rating","reviews",
  "revenue30d","unitSales30d",
  "revenue30Day","unitSales30Day",   // fallback if some files use Day
  "category1","bsr1",
  "category2","bsr2",
  "url"
];
/* ================================ */

let table = null;
let currentCSV = CSV_FILES[0];
let lastRows = [];

const isMobile = () => window.matchMedia("(max-width: 820px)").matches;

function setStatus(msg){ document.getElementById("status").textContent = msg || ""; }

function moneyToNum(v){
  if (v === null || v === undefined) return 0;
  const s = String(v).trim().replace(/[^0-9.]/g,'');
  return s ? parseFloat(s) : 0;
}
function safeText(v){ return (v === null || v === undefined) ? "" : String(v); }

// get first existing field value among multiple possible names
function field(row, names){
  for (const n of names) {
    if (row && Object.prototype.hasOwnProperty.call(row, n) && safeText(row[n]).trim() !== "") return row[n];
  }
  return "";
}

function buildColumns(sampleRow){
  const keys = new Set(Object.keys(sampleRow || {}));
  return VISIBLE_COLS
    .filter(c => keys.has(c))
    .map(c => ({
      title: c,
      data: c,
      className: (c === "title") ? "col-title" : ""
    }));
}

function loadCSV(filename){
  currentCSV = filename;
  setStatus("Loading: " + filename);

  fetch(encodeURI(filename), { cache: "no-store" })
    .then(res => {
      if (!res.ok) throw new Error("CSV not found: " + filename);
      return res.text();
    })
    .then(text => {
      Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        complete: res => {
          lastRows = (res.data || []).filter(r => r && Object.keys(r).length);
          render();
        }
      });
    })
    .catch(err => {
      console.error(err);
      setStatus("Error: " + err.message);
      alert(err.message);
    });
}

function normalizeRows(rows){
  return rows.map(r => {
    const out = {...r};

    const rev = field(out, ["revenue30d","revenue30Day"]);
    const units = field(out, ["unitSales30d","unitSales30Day"]);

    out.__revenue_num = moneyToNum(rev);
    out.__price_num = moneyToNum(out.price);

    // image clickable to url
    const img = safeText(out.image);
    const url = safeText(out.url);

    if (img && url) {
      out.image = `
        <a href="${url}" target="_blank" rel="noopener">
          <div class="img-wrap"><img src="${img}" loading="lazy"></div>
        </a>`;
    } else {
      out.image = "";
    }

    out.url = url ? `<a href="${url}" target="_blank" rel="noopener">open</a>` : "";
    return out;
  });
}

/* ===== Mobile cards renderer (clean + focused) ===== */
function renderCards(rows, query){
  const cards = document.getElementById("cards");
  const q = (query || "").trim().toLowerCase();

  let filtered = rows;
  if (q) {
    filtered = rows.filter(r => {
      const hay = [
        safeText(r.title),
        safeText(r.category1), safeText(r.category2),
        safeText(r.price), safeText(r.rating)
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  // sort by revenue desc
  filtered.sort((a,b) => moneyToNum(field(b,["revenue30d","revenue30Day"])) - moneyToNum(field(a,["revenue30d","revenue30Day"])));

  cards.innerHTML = filtered.map(r => {
    const title = safeText(r.title);
    const price = safeText(r.price);
    const rating = safeText(r.rating);
    const reviews = safeText(r.reviews);

    const cat1 = safeText(r.category1);
    const bsr1 = safeText(r.bsr1);
    const cat2 = safeText(r.category2);
    const bsr2 = safeText(r.bsr2);

    const rev = safeText(field(r, ["revenue30d","revenue30Day"]));
    const units = safeText(field(r, ["unitSales30d","unitSales30Day"]));

    const img = safeText(r.image);
    const url = safeText(r.url);

    const imgBox = (img && url)
      ? `<a class="card-img" href="${url}" target="_blank" rel="noopener">
           <img src="${img}" loading="lazy" />
         </a>`
      : `<div class="card-img" style="width:78px;height:78px;"></div>`;

    const openBtn = url ? `<a class="btn primary" href="${url}" target="_blank" rel="noopener">Open</a>` : "";

    const pill = (label, val) => (val ? `<span class="pill">${label} ${val}</span>` : "");

    return `
      <div class="card">
        ${imgBox}
        <div class="card-main">
          <div class="card-title">${title || "(no title)"}</div>

          <div class="meta">
            ${pill("üí∞", price)}
            ${pill("‚≠ê", rating)}
            ${pill("üßæ", reviews)}
            ${cat1 ? `<span class="pill">üè∑ ${cat1}${bsr1 ? ` (#${bsr1})` : ""}</span>` : ""}
            ${cat2 ? `<span class="pill">üè∑ ${cat2}${bsr2 ? ` (#${bsr2})` : ""}</span>` : ""}
            ${pill("üìà Rev30", rev)}
            ${pill("üì¶ Units30", units)}
          </div>

          <div class="card-actions">
            ${openBtn}
          </div>
        </div>
      </div>
    `;
  }).join("");

  setStatus(`Loaded ${filtered.length} rows`);
}

/* ===== Desktop table renderer ===== */
function renderTable(rows, query){
  const norm = normalizeRows(rows);

  if (table) {
    table.destroy();
    $("#csvTable").empty();
    table = null;
  }
  if (!norm.length) return;

  let columns = buildColumns(norm[0]);
  columns.push({ title:"__revenue_num", data:"__revenue_num" });
  columns.push({ title:"__price_num", data:"__price_num" });

  const revIdx = columns.findIndex(c => c.data === "__revenue_num");
  const priceIdx = columns.findIndex(c => c.data === "__price_num");

  table = $("#csvTable").DataTable({
    data: norm,
    columns,
    columnDefs: [
      { targets: [revIdx, priceIdx], visible:false, searchable:false }
    ],
    order: revIdx >= 0 ? [[revIdx,"desc"]] : [],
    pageLength: 50,
    lengthMenu: [10,25,50,100,200],
    scrollX: true,
    deferRender: true,
    processing: true,
    // remove default DT search box (we already have one)
    dom: "Brtip",
    buttons: ["copy","csv","excel","print"]
  });

  if (query) table.search(query).draw();
  setStatus(`Loaded ${norm.length} rows`);
}

function render(){
  const q = document.getElementById("quickSearch").value || "";

  document.getElementById("cards").style.display = isMobile() ? "block" : "none";
  document.getElementById("csvTable").style.display = isMobile() ? "none" : "table";

  if (isMobile()) renderCards(lastRows, q);
  else renderTable(lastRows, q);
}

/* dropdown */
const sel = document.getElementById("csvSelect");
CSV_FILES.forEach(f => sel.add(new Option(f,f)));
sel.value = currentCSV;
sel.onchange = () => loadCSV(sel.value);

document.getElementById("reloadBtn").onclick = () => loadCSV(currentCSV);
document.getElementById("quickSearch").addEventListener("input", render);

window.addEventListener("resize", () => {
  clearTimeout(window.__rT);
  window.__rT = setTimeout(render, 150);
});

/* auto-load */
loadCSV(currentCSV);
</script>
</body>
</html>
