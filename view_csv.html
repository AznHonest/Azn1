<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CSV Browser</title>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

<style>
  body { font-family: Arial, sans-serif; margin: 18px; }
  h2 { margin: 0 0 10px 0; font-size: 18px; }

  /* Center everything */
  #csvTable th, #csvTable td { text-align: center; vertical-align: middle; }

  /* Title column: align left */
  #csvTable th.col-title, #csvTable td.col-title { text-align: left !important; }

  img { max-height: 40px; border-radius: 6px; }

  table.dataTable thead th { position: sticky; top: 0; background: #fff; z-index: 2; }
</style>
</head>

<body>
<h2>CSV Browser</h2>

<table id="csvTable" class="display compact stripe" style="width:100%"></table>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* ================= CONFIG ================= */
const AUTO_CSV = "first_aid_Search_7pages_amazon_2026-01-28_320_products.csv";

const VISIBLE_COLS = [
  "image", "title", "price", "rating", "reviews",
  "revenue30Day", "unitSales30Day",
  "category1", "bsr1",
  "category2", "bsr2",
  "category3", "bsr3",
  "url"
];
/* ========================================== */

function moneyToNum(v){
  if (v === null || v === undefined) return 0;
  const s = String(v).trim().replace(/[^0-9.]/g,'');
  return s ? parseFloat(s) : 0;
}

function safeIndex(cols, name){
  const i = cols.findIndex(c => c.data === name);
  return i >= 0 ? i : null;
}

let table = null;
let idx = {};

function buildColumns(sampleRow){
  const keys = new Set(Object.keys(sampleRow || {}));
  return VISIBLE_COLS
    .filter(c => keys.has(c))
    .map(c => ({
      title: c,
      data: c,
      className: c === "title" ? "col-title" : ""
    }));
}

function loadTable(rows){
  // تنظيف صفوف فاضية
  rows = (rows || []).filter(r => r && Object.keys(r).length);

  if (!rows.length) return;

  // ✅ مهم: نضمن الأعمدة المساعدة موجودة في كل صف
  rows.forEach(r => {
    r.price_num = moneyToNum(r.price);
    r.revenue30Day_num = moneyToNum(r.revenue30Day);

    if (r.image) {
      const img = String(r.image).trim();
      r.image = img ? `<a href="${img}" target="_blank" rel="noopener"><img src="${img}" loading="lazy"></a>` : "";
    } else {
      r.image = "";
    }

    if (r.url) {
      const u = String(r.url).trim();
      r.url = u ? `<a href="${u}" target="_blank" rel="noopener">open</a>` : "";
    } else {
      r.url = "";
    }
  });

  let columns = buildColumns(rows[0]);

  // أضف الأعمدة المساعدة (مخفية) للفرز الصحيح
  columns.push({ title:"revenue30Day_num", data:"revenue30Day_num" });
  columns.push({ title:"price_num", data:"price_num" });

  idx.rev = safeIndex(columns, "revenue30Day_num");
  idx.price = safeIndex(columns, "price_num");

  if (table) {
    table.destroy();
    document.querySelector("#csvTable").innerHTML = "";
  }

  table = $('#csvTable').DataTable({
    data: rows,
    columns,
    columnDefs: [
      { targets: [idx.rev, idx.price], visible: false, searchable: false }
    ],
    order: idx.rev !== null ? [[idx.rev, "desc"]] : [],
    pageLength: 50,
    scrollX: true,
    deferRender: true,
    dom: "Bfrtip",
    buttons: ["copy", "csv", "excel", "print"]
  });
}

/* auto load CSV from same folder */
fetch(AUTO_CSV, { cache: "no-store" })
  .then(res => {
    if (!res.ok) throw new Error("CSV not found: " + AUTO_CSV);
    return res.text();
  })
  .then(csvText => {
    Papa.parse(csvText, {
      header: true,
      skipEmptyLines: true,
      complete: (results) => loadTable(results.data)
    });
  })
  .catch(err => {
    alert("Failed to load CSV: " + err.message);
    console.error(err);
  });
</script>

</body>
</html>
