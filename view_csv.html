<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CSV Browser Pro</title>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

<style>
  body { font-family: Arial, sans-serif; margin: 18px; }
  h2 { margin: 0 0 10px 0; font-size: 18px; }
  .bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 10px; }
  .bar2 { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin: 10px 0 12px; }
  select, input[type="file"], input[type="text"], button, label { padding: 6px; }
  button { cursor: pointer; }
  .pill { padding: 4px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; background: #fafafa; }
  .muted { color: #666; font-size: 12px; }
  table.dataTable thead th { position: sticky; top: 0; background: #fff; z-index: 2; }
  td { vertical-align: middle; }
  img { max-height: 40px; border-radius: 6px; }
  .right { text-align: right; }
  .wrap { white-space: normal !important; }
</style>
</head>

<body>
  <h2>CSV Browser Pro</h2>

  <div class="bar">
    <input type="file" id="fileInput" accept=".csv" />

    <input id="quickSearch" type="text" placeholder="Quick search..." disabled />

    <label class="pill">
      <input type="checkbox" id="toggleImages" checked /> Show images
    </label>

    <label class="pill">
      <input type="checkbox" id="toggleWrap" /> Wrap text
    </label>

    <button id="btnReload">Reload server CSV</button>
    <button id="btnReset" disabled>Reset filters</button>
  </div>

  <div class="bar2">
    <span class="pill" id="statRows">Rows: -</span>
    <span class="pill" id="statVisible">Visible: -</span>
    <span class="pill" id="statRev">Revenue (visible): -</span>
    <span class="pill" id="statUnits">Units (visible): -</span>
    <span class="muted" id="statusText">Waiting for CSV...</span>
  </div>

  <table id="csvTable" class="display compact stripe" style="width:100%"></table>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* ================== CONFIG ================== */
const AUTO_CSV = "first_aid_Search_7pages_amazon_2026-01-28_320_products.csv";

// الترتيب اللي طلبته — أي أعمدة غير موجودة هنا لن تظهر
const VISIBLE_COLS = [
  "image", "title", "price", "rating", "reviews",
  "revenue30Day", "unitSales30Day",
  "category1", "bsr1", "category2", "bsr2", "category3", "bsr3",
  "url"
];
/* ============================================ */

function moneyToNum(v){
  if (v === null || v === undefined) return 0;
  const s = String(v).trim().replace(/[^0-9.]/g,'');
  return s ? parseFloat(s) : 0;
}
function numToFloat(v){
  if (v === null || v === undefined) return 0;
  const s = String(v).trim().replace(/[^0-9.]/g,'');
  return s ? parseFloat(s) : 0;
}
function fmtNum(n){
  try { return new Intl.NumberFormat().format(n); } catch { return String(n); }
}
function fmtMoney(n){
  try { return new Intl.NumberFormat(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n); }
  catch { return String(n); }
}
function setText(id, txt){ document.getElementById(id).textContent = txt; }
function safeIndex(columns, name){
  const i = columns.findIndex(c => c.data === name);
  return i >= 0 ? i : null;
}

let table = null;
let idx = {};

const quickSearch = document.getElementById("quickSearch");
const toggleImages = document.getElementById("toggleImages");
const toggleWrap = document.getElementById("toggleWrap");
const btnReset = document.getElementById("btnReset");
const btnReload = document.getElementById("btnReload");

function resetFilters(){
  quickSearch.value = "";
  if (!table) return;
  table.search("").columns().search("").draw();
  updateStats();
}
btnReset.addEventListener("click", resetFilters);

function buildColumnsFromOrder(sampleRow){
  const existing = new Set(Object.keys(sampleRow || {}));

  // فقط الأعمدة المطلوبة وبنفس الترتيب
  const cols = VISIBLE_COLS
    .filter(c => existing.has(c))
    .map(k => ({
      title: k,
      data: k,
      className: (
        ["price","rating","reviews","revenue30Day","unitSales30Day","bsr1","bsr2","bsr3"].includes(k)
      ) ? "right" : ""
    }));

  return cols;
}

function loadTableFromParsed(data){
  const rows = (data || []).filter(r => r && Object.keys(r).length);
  if (!rows.length) {
    setText("statusText", "No rows found in CSV.");
    return;
  }

  // enrich rows (link/image) + numeric helpers
  rows.forEach(r => {
    // money helpers for proper sorting
    if ("revenue30Day" in r) r.revenue30Day_num = moneyToNum(r.revenue30Day);
    if ("price" in r)        r.price_num        = moneyToNum(r.price);
    if ("unitSales30Day" in r) r.unitSales30Day_num = numToFloat(r.unitSales30Day);

    // clickable url
    if (r.url) {
      const u = String(r.url).trim();
      r._raw_url = u;
      r.url = u ? `<a href="${u}" target="_blank" rel="noopener">open</a>` : "";
    }

    // image preview
    if (r.image) {
      const img = String(r.image).trim();
      r._raw_image = img;
      r.image = img ? `<a href="${img}" target="_blank" rel="noopener"><img src="${img}" loading="lazy"></a>` : "";
    }
  });

  // Build visible columns in your order
  let columns = buildColumnsFromOrder(rows[0]);

  // Add helper columns (hidden) to enable correct numeric sorting
  if (!columns.find(c => c.data === "revenue30Day_num") && rows[0].revenue30Day_num !== undefined) {
    columns.push({ title: "revenue30Day_num", data: "revenue30Day_num", className: "right" });
  }
  if (!columns.find(c => c.data === "price_num") && rows[0].price_num !== undefined) {
    columns.push({ title: "price_num", data: "price_num", className: "right" });
  }
  if (!columns.find(c => c.data === "unitSales30Day_num") && rows[0].unitSales30Day_num !== undefined) {
    columns.push({ title: "unitSales30Day_num", data: "unitSales30Day_num", className: "right" });
  }

  idx.revenueNum = safeIndex(columns, "revenue30Day_num");
  idx.unitsNum   = safeIndex(columns, "unitSales30Day_num");
  idx.image      = safeIndex(columns, "image");

  // Destroy old table
  if (table) {
    table.destroy();
    document.querySelector("#csvTable").innerHTML = "";
    table = null;
  }

  // Hide helper numeric columns
  const columnDefs = [];
  if (idx.revenueNum !== null) columnDefs.push({ targets: idx.revenueNum, visible: false, searchable: false });
  if (safeIndex(columns, "price_num") !== null) columnDefs.push({ targets: safeIndex(columns, "price_num"), visible: false, searchable: false });
  if (idx.unitsNum !== null) columnDefs.push({ targets: idx.unitsNum, visible: false, searchable: false });

  // Default sort by revenue desc
  const defaultOrder = (idx.revenueNum !== null) ? [[idx.revenueNum, "desc"]] : [];

  table = $('#csvTable').DataTable({
    data: rows,
    columns,
    columnDefs,

    pageLength: 50,
    lengthMenu: [10, 25, 50, 100, 200],
    scrollX: true,
    stateSave: true,
    order: defaultOrder,

    deferRender: true,
    processing: true,

    dom: "Bfrtip",
    buttons: ["copy", "csv", "excel", "print"]
  });

  // Toggle images show/hide
  if (idx.image !== null) table.column(idx.image).visible(toggleImages.checked);
  toggleImages.onchange = function(){
    if (!table || idx.image === null) return;
    table.column(idx.image).visible(this.checked);
    updateStats();
  };

  // Toggle wrap
  toggleWrap.onchange = function(){
    const el = document.getElementById("csvTable");
    if (this.checked) el.classList.add("wrap");
    else el.classList.remove("wrap");
  };

  // Search
  quickSearch.disabled = false;
  btnReset.disabled = false;

  let t = null;
  quickSearch.oninput = function(){
    clearTimeout(t);
    t = setTimeout(() => {
      table.search(this.value).draw();
      updateStats();
    }, 200);
  };

  table.on("draw", updateStats);

  setText("statusText", `Loaded ${rows.length} rows`);
  updateStats();
}

function updateStats(){
  if (!table) return;

  const total = table.data().length;
  const visible = table.rows({ filter: "applied" }).data().length;

  let rev = 0, units = 0;
  const filtered = table.rows({ filter: "applied" }).data().toArray();
  for (const r of filtered) {
    if (idx.revenueNum !== null) rev += (r.revenue30Day_num || 0);
    if (idx.unitsNum !== null) units += (r.unitSales30Day_num || 0);
  }

  setText("statRows", `Rows: ${fmtNum(total)}`);
  setText("statVisible", `Visible: ${fmtNum(visible)}`);
  setText("statRev", `Revenue (visible): ${fmtMoney(rev)}`);
  setText("statUnits", `Units (visible): ${fmtNum(units)}`);
}

/* -------- manual upload -------- */
document.getElementById('fileInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  setText("statusText", "Loading local CSV...");
  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    worker: true,
    complete: function(results) {
      loadTableFromParsed(results.data);
    }
  });
});

/* -------- auto-load from server -------- */
function loadServerCSV(){
  setText("statusText", `Loading server CSV: ${AUTO_CSV} ...`);
  fetch(AUTO_CSV, { cache: "no-store" })
    .then(res => {
      if (!res.ok) throw new Error("CSV not found: " + AUTO_CSV);
      return res.text();
    })
    .then(csvText => {
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          loadTableFromParsed(results.data);
        }
      });
    })
    .catch(err => {
      console.warn(err);
      setText("statusText", `Auto-load failed. Use Choose File. (${err.message})`);
    });
}

btnReload.addEventListener("click", loadServerCSV);
loadServerCSV();
</script>
</body>
</html>
