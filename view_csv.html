<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CSV Browser</title>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

<style>
  body { font-family: Arial, sans-serif; margin: 18px; }
  h2 { margin: 0 0 10px 0; font-size: 18px; }

  /* Center everything */
  #csvTable th,
  #csvTable td {
    text-align: center;
    vertical-align: middle;
  }

  /* Title column: align left */
  #csvTable th.col-title,
  #csvTable td.col-title {
    text-align: left !important;
  }

  img { max-height: 40px; border-radius: 6px; }

  table.dataTable thead th {
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 2;
  }
</style>
</head>

<body>
<h2>CSV Browser</h2>

<table id="csvTable" class="display compact stripe" style="width:100%"></table>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* ================= CONFIG ================= */
const AUTO_CSV = "first_aid_Search_7pages_amazon_2026-01-28_320_products.csv";

const VISIBLE_COLS = [
  "image", "title", "price", "rating", "reviews",
  "revenue30Day", "unitSales30Day",
  "category1", "bsr1",
  "category2", "bsr2",
  "category3", "bsr3",
  "url"
];
/* ========================================== */

function moneyToNum(v){
  if (!v) return 0;
  const s = String(v).replace(/[^0-9.]/g,'');
  return s ? parseFloat(s) : 0;
}

function safeIndex(cols, name){
  const i = cols.findIndex(c => c.data === name);
  return i >= 0 ? i : null;
}

let table = null;
let idx = {};

function buildColumns(row){
  const keys = new Set(Object.keys(row || {}));
  return VISIBLE_COLS
    .filter(c => keys.has(c))
    .map(c => ({
      title: c,
      data: c,
      className: c === "title" ? "col-title" : ""
    }));
}

function loadTable(data){
  if (!data || !data.length) return;

  data.forEach(r => {
    if (r.image) {
      const img = r.image;
      r.image = `<a href="${img}" target="_blank"><img src="${img}"></a>`;
    }
    if (r.url) {
      const u = r.url;
      r.url = `<a href="${u}" target="_blank">open</a>`;
    }
    if (r.revenue30Day) r.revenue30Day_num = moneyToNum(r.revenue30Day);
    if (r.price) r.price_num = moneyToNum(r.price);
  });

  let columns = buildColumns(data[0]);

  // hidden numeric helpers
  columns.push({ title:"revenue30Day_num", data:"revenue30Day_num" });
  columns.push({ title:"price_num", data:"price_num" });

  idx.rev = safeIndex(columns,"revenue30Day_num");
  idx.price = safeIndex(columns,"price_num");

  if (table) {
    table.destroy();
    document.querySelector("#csvTable").innerHTML = "";
  }

  table = $('#csvTable').DataTable({
    data,
    columns,
    columnDefs: [
      { targets: [idx.rev, idx.price], visible:false, searchable:false }
    ],
    order: idx.rev !== null ? [[idx.rev,"desc"]] : [],
    pageLength: 50,
    scrollX: true,
    dom: "Bfrtip",
    buttons: ["csv","excel"],
    deferRender: true
  });
}

/* auto load CSV from same folder */
fetch(AUTO_CSV, { cache: "no-store" })
  .then(r => r.text())
  .then(t => Papa.parse(t, {
    header:true,
    skipEmptyLines:true,
    complete: res => loadTable(res.data)
  }));
</script>

</body>
</html>
